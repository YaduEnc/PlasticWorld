---
config:
  layout: dagre
---
flowchart TB
 subgraph subGraph0["Client Layer"]
        WEB["Web App<br>React.js/Next.js"]
        MOBILE["Mobile Apps<br>React Native<br>iOS &amp; Android"]
        WEB_SOCKET_CLIENT["WebSocket Client<br>Socket.io-client"]
        ENCRYPTION_CLIENT["E2E Encryption<br>Signal Protocol<br>Client-side Keys"]
  end
 subgraph subGraph1["CDN & Security Layer"]
        CF["Cloudflare<br>DNS + DDoS Protection"]
        CF_TUNNEL["Cloudflare Tunnel<br>cloudflared daemon"]
        SSL["SSL/TLS 1.3<br>Certificate Management"]
  end
 subgraph subGraph2["Reverse Proxy Layer"]
        NGINX["Nginx<br>Reverse Proxy<br>Load Balancer<br>Rate Limiting"]
  end
 subgraph subGraph3["API Gateway"]
        API_GATEWAY["API Gateway<br>Request Routing<br>JWT Validation<br>Version Control /api/v1/"]
  end
 subgraph subGraph4["Authentication Service"]
        AUTH_API["Auth API<br>REST Endpoints"]
        FIREBASE_ADMIN["Firebase Admin SDK<br>Token Verification"]
        JWT_SERVICE["JWT Service<br>Access &amp; Refresh Tokens"]
        SESSION_MGR["Session Manager<br>Redis-based Sessions"]
  end
 subgraph subGraph5["User Service"]
        USER_API["User API<br>Profile CRUD"]
        USER_SEARCH["Search Engine<br>Indexed Queries<br>Username/Email/Phone"]
        USER_VALIDATOR["Validation Service<br>Uniqueness Checks"]
  end
 subgraph subGraph6["Friendship Service"]
        FRIEND_API["Friendship API<br>Request Management"]
        FRIEND_STATE["State Machine<br>Pendingâ†’Accepted/Denied"]
        BLOCK_SERVICE["Block/Unblock Service"]
  end
 subgraph subGraph7["Messaging Service"]
        MSG_API["Message API<br>REST Endpoints"]
        WS_SERVER["WebSocket Server<br>Socket.io<br>Real-time Events"]
        MSG_QUEUE["Message Queue<br>Offline User Handling"]
        TYPING_SERVICE["Typing Indicators<br>Ephemeral Events"]
        RECEIPT_SERVICE["Read Receipts<br>Delivery Status"]
  end
 subgraph subGraph8["Encryption Service"]
        KEY_EXCHANGE["Key Exchange<br>X3DH Protocol"]
        DOUBLE_RATCHET["Double Ratchet<br>Forward Secrecy"]
        KEY_STORAGE["Server Key Store<br>Public Keys Only"]
  end
 subgraph subGraph9["Application Services Layer"]
        subGraph4
        subGraph5
        subGraph6
        subGraph7
        subGraph8
  end
 subgraph subGraph10["PostgreSQL Database"]
        DB_USERS[("Users Table<br>id, firebase_uid<br>username, email<br>phone, name, age")]
        DB_FRIENDS[("Friendships Table<br>requester_id<br>addressee_id<br>status, timestamps")]
        DB_MESSAGES[("Messages Table<br>sender_id, recipient_id<br>encrypted_content<br>status, timestamps")]
        DB_KEYS[("Encryption Keys<br>user_id, device_id<br>identity_key<br>prekeys")]
  end
 subgraph subGraph11["Redis Cache"]
        REDIS_SESSION["Session Store<br>session:user_id"]
        REDIS_ONLINE["Online Status<br>online:user_id<br>TTL: 30s"]
        REDIS_TYPING["Typing Indicators<br>typing:conv_id:user_id<br>TTL: 3s"]
        REDIS_QUEUE["Message Queue<br>msg_queue:user_id"]
        REDIS_RATE["Rate Limiting<br>rate_limit:user_id"]
  end
 subgraph subGraph12["Data Layer"]
        subGraph10
        subGraph11
  end
 subgraph subGraph13["External Services"]
        FIREBASE["Firebase Auth<br>Google Sign-In<br>OAuth Provider"]
  end
 subgraph subGraph14["Monitoring & Logging"]
        PROMETHEUS["Prometheus<br>Metrics Collection<br>API/WebSocket/DB metrics"]
        GRAFANA["Grafana<br>Dashboards<br>Alerts"]
        LOGS["Application Logs<br>Winston/Python Logging<br>Structured JSON"]
  end
 subgraph Infrastructure["Infrastructure"]
        DOCKER["Docker Containers<br>Isolated Services"]
        LINUX["Linux Server<br>Ubuntu/Debian<br>Self-hosted"]
  end
    WEB --> CF
    MOBILE --> CF
    CF --> CF_TUNNEL
    CF_TUNNEL --> SSL
    SSL --> NGINX
    NGINX --> API_GATEWAY & REDIS_RATE
    API_GATEWAY --> AUTH_API & USER_API & FRIEND_API & MSG_API
    NGINX -. ws:// .-> WS_SERVER
    AUTH_API --> FIREBASE_ADMIN & JWT_SERVICE
    FIREBASE_ADMIN --> FIREBASE
    JWT_SERVICE --> SESSION_MGR
    SESSION_MGR --> REDIS_SESSION
    USER_API --> USER_SEARCH & USER_VALIDATOR & DB_USERS
    FRIEND_API --> FRIEND_STATE & BLOCK_SERVICE & DB_FRIENDS
    MSG_API --> MSG_QUEUE & DB_MESSAGES & KEY_EXCHANGE
    WS_SERVER --> TYPING_SERVICE & RECEIPT_SERVICE & REDIS_ONLINE
    MSG_QUEUE --> REDIS_QUEUE
    TYPING_SERVICE --> REDIS_TYPING
    RECEIPT_SERVICE --> DB_MESSAGES
    KEY_EXCHANGE --> DOUBLE_RATCHET
    DOUBLE_RATCHET --> KEY_STORAGE
    KEY_STORAGE --> DB_KEYS
    WEB_SOCKET_CLIENT --> ENCRYPTION_CLIENT
    ENCRYPTION_CLIENT -. Encrypted Payload .-> WS_SERVER
    AUTH_API -. Metrics .-> PROMETHEUS
    USER_API -. Metrics .-> PROMETHEUS
    FRIEND_API -. Metrics .-> PROMETHEUS
    MSG_API -. Metrics .-> PROMETHEUS
    WS_SERVER -. Metrics .-> PROMETHEUS
    DB_USERS -. Metrics .-> PROMETHEUS
    PROMETHEUS --> GRAFANA
    AUTH_API -. Logs .-> LOGS
    USER_API -. Logs .-> LOGS
    FRIEND_API -. Logs .-> LOGS
    MSG_API -. Logs .-> LOGS
    WS_SERVER -. Logs .-> LOGS
    DOCKER --> AUTH_API & USER_API & FRIEND_API & MSG_API & WS_SERVER & DB_USERS & REDIS_SESSION & NGINX
    LINUX --> DOCKER

    style WEB fill:#61dafb
    style MOBILE fill:#61dafb
    style CF fill:#f38020
    style NGINX fill:#009639
    style DB_USERS fill:#336791
    style DB_FRIENDS fill:#336791
    style DB_MESSAGES fill:#336791
    style DB_KEYS fill:#336791
    style REDIS_SESSION fill:#dc382d
    style REDIS_ONLINE fill:#dc382d
    style REDIS_TYPING fill:#dc382d
    style REDIS_QUEUE fill:#dc382d
    style FIREBASE fill:#ffca28
    style PROMETHEUS fill:#e6522c
    style GRAFANA fill:#f46800
    style DOCKER fill:#2496ed
    style LINUX fill:#fcc624